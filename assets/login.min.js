/*global json err inf webwsocket*/

let wsocket = new WebSocket(websocket+"/anon")
wsocket.onerror = function (e) { err("Something wrong has happened with the back of the server. Please DM the administrators on discord.") }
wsocket.onclose = function (e) { err("Something wrong has happened with the server. Please DM the admins on discord.") }
function auth () {
  wsocket.onmessage = function (jsonResponse) {
    let data = JSON.parse(jsonResponse.data)
    if (data.ok === false) {
      switch (data.msg) {
        case "CONF_EMAIL":
          inf("You can't be logged in unless you confirm your email.")
        break;
        case "INC_DATA":
          err("Yout username or password is incorrect.<br>Need a <a href='#' style='color: black;' onclick='reset()'>change</a>?")
        break;
      }
    } else {
      wsocket.onclose = undefined
      wsocket.close()
      document.cookie = 'token=' + data.data, window.location = 'index'
    }
  }
  wsocket.send(JSON.stringify({
    cmd: "authenticate",
    data: {
      username: document.getElementById("un").value.toLowerCase(),
      password: document.getElementById("pw").value
    }
  }))
}

function reset () {
  if (document.getElementById("un").value === undefined) {
    err("There's no username.")
    return;
  }
  wsocket.onmessage = function (e) {
    let data = JSON.parse(e.data)
    if (data.ok === false) {
      err("Something is wrong. Try again.")
    } else {
      inf('An email has been sent to your account regarding the password reset.')
    }
  }
  wsocket.send(JSON.stringify({
    cmd: "reset",
    data: document.getElementById("un").value.toLowerCase()
  }))
}